<queries>
  <query name="net.ksdr1.powerschool.oneroster.enrollments" coreTable="cc" flattened="true">
	<summary>OneRoster 1.1 enrollments</summary>
    <columns>
      <column column="CC.STUDENTSECTENRL_GUID">a_sourcedid</column>
	  <column column="CC.SECTION_NUMBER">b_status</column>
	  <column column="CC.LASTGRADEUPDATE">c_datelastmodified</column>
	  <column column="CC.SECTIONID">d_classSourcedId</column>
	  <column column="CC.ID">e_schoolSourcedId</column>
	  <column column="CC.COURSE_NUMBER">f_userSourcedId</column>
	  <column column="CC.EXPRESSION">g_role</column>
	  <column column="CC.AB_COURSE_CMP_FUN_FLG">h_primary</column>
	  <column column="CC.DATEENROLLED">i_beginDate</column>
	  <column column="CC.DATELEFT">k_endDate</column>
    </columns>
    <sql><![CDATA[
with yearquery as (select 
  id, abbreviation
from terms
where portion = 1
  AND sysdate BETWEEN firstday-30 and lastday+30
  AND schoolid=0
)

select 
  'T'||sectionteacher.id as sourcedId,
  'active' as status,
  to_char(sysdate,'yyyy-mm-dd"T"hh24' || chr(58) || 'mi' || chr(58) || 'ss".000Z"') as dateLastModified,
  sectionteacher.sectionid as classSourcedId,
  sections.schoolid as schoolSourcedId,
  'T'||schoolstaff.users_dcid as userSourcedId,
  case sectionteacher.roleid
    when 21 then 'teacher'
    when 22 then 'teacher'
    when 24 then 'aide'
    else 'aide'
  end as role,
  case sectionteacher.roleid
    when 21 then 'true'
    when 22 then 'false'
    when 24 then 'false'
    else 'false'
  end as primary,
  to_char(sectionteacher.start_date,'yyyy-mm-dd') as beginDate,
  to_char(sectionteacher.end_date,'yyyy-mm-dd') as endDate
  
  
from sectionteacher
left join schoolstaff on schoolstaff.id = sectionteacher.teacherid
left join sections on sectionteacher.sectionid = sections.id
where sectionteacher.roleid in (21,22)
and sectionteacher.sectionid in 
(
  select sections.id from sections
  left join yearquery on 1=1
  where sections.termid between yearquery.id and yearquery.id+99
)
union all

select
 'S'||cc.dcid as sourcedId,
 'active' as status,
 to_char(sysdate,'yyyy-mm-dd"T"hh24' || chr(58) || 'mi' || chr(58) || 'ss".000Z"') as dateLastModified,
 cc.sectionid as classSourcedId,
 cc.schoolid as schoolSourcedId,
 'S'||students.dcid as userSourcedId,
 'student' as role,
 null as primary,
 to_char(cc.dateenrolled,'yyyy-mm-dd') as beginDate,
 to_char(cc.dateleft,'yyyy-mm-dd') as endDate
from cc
left join students on cc.studentid = students.id
left join yearquery on 1=1
where cc.termid between yearquery.id and yearquery.id+99
    ]]></sql>
  </query>
  <!-- Define more queries here -->
</queries>